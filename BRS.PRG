SET DATE FRENCH
SET DATE FORMAT TO "dd/mm/yyyy"
SET DECIMALS TO 2
SET FIXED ON
SET EXACT OFF
SET EXCLUSIVE ON
**********************************************************************
*** VARIAVEIS  BR_
*******************************

BR_LOCAL="Qualquer agencia bancaria ate o vencimento     "
STORE CTOD(" ") TO BR_VENC,BR_DATAIMPR,BR_DATADOC
STORE 0 TO BR_NUMDOC,BR_VALOR,BR_DESC,BR_ABAT,BR_MORA,BR_MULTA,BR_TOTAL,BR_NUMEMP

STORE SPACE(78) TO BR_INSTR2,BR_INSTR3,BR_INSTR4,BR_INSTR5,BR_INSTR6
STORE SPACE(40) TO BR_INSTR6,BR_INSTR7

STORE SPACE(78) TO BR_SACADO1,BR_SACADO2

BR_DATAIMPR=DATE()
BR_DATADOC=DATE()

BR_NOME:=BR_ENDER:=SPACE(50)
BR_CIDADE:=BR_BAIRRO:=SPACE(20)
BR_UF=SPACE(2)
BR_CNPJ=SPACE(24)



BR_DB1={"R_NUMEMP","R_VENC","R_VALOR","SUBSTR(R_INSTR3,1,20)","SUBSTR(R_INSTR2,1,20)"}
BR_DB2={"9999","99/99","@E 9,999.99","",""}
BR_DB3={"NUM","VENC. ","VALOR","INSTR_3","INSTR_2"}

****** VARIAVEIS DO TESTE DE APAGAR LINHA REPETIDA *******************
BBR_LOCAL="Qualquer agencia bancaria ate o vencimento     "

STORE CTOD(" ") TO BBR_VENC,BBR_DATAIMPR,BBR_DATADOC
STORE 0 TO BBR_NUMDOC,BBR_VALOR,BBR_DESC,BBR_ABAT,BBR_MORA,BBR_MULTA,BBR_TOTAL,BBR_NUMEMP

STORE SPACE(78) TO BBR_INSTR2,BBR_INSTR3,BBR_INSTR4,BBR_INSTR5,BBR_INSTR6
STORE SPACE(40) TO BBR_INSTR6,BBR_INSTR7

STORE SPACE(78) TO BBR_SACADO1,BBR_SACADO2

BBR_DATAIMPR=DATE()
BBR_DATADOC=DATE()

BBR_NOME:=BBR_ENDER:=SPACE(50)
BBR_CIDADE:=BBR_BAIRRO:=SPACE(20)
BBR_UF=SPACE(2)
BBR_CNPJ=SPACE(24)



**********************************************************************

DO WHILE .T.

   DO WHILE .NOT. LASTKEY()=27
        set key -1 to consulta_brs()
        SET KEY 376 TO BRS_LIMPA()
	SET COLOR TO &Cor23
        CLEAR
	@ 00,00 TO 24,79 DOUBLE
        @ 00,10 SAY "PROGRAMA DE IMPRESSAO DA COBRANCA BANRISUL"
        @ 01,65 say "<F2> Consulta"
        @ 02,65 say "<Alt>+<1> Apag.Rept"
        GETS_BRS()
	READ

        SET KEY -1 TO
      CENTRA(22," T E C L E   < E N T E R >   P A R A   I M P R I M I R ")
      INKEY(0)
      IF LASTKEY()=13
	BR_IMPRIME()
        
	BR_GRAVADOC()
      ENDIF
   ENDDO

   SINAO=AVISO2("  SAIR?","nao","sim")
   IF SINAO=1
      set key -1 to 
      EXIT
   ENDIF
   LOOP
ENDDO
CLOSE ALL
SET COLOR TO
@ 00,00 SAY " "
SET DECIMALS TO 0
*CLEAR
***********************
FUNCTION GETS_BRS()
**********************
        @ 02,02 GET BR_LOCAL

        @ 03,02 SAY "Vencimento"
        @ 03,14 SAY "Data doc." 
        @ 03,26 SAY "Num. doc."
        @ 03,38 SAY "Data impr"
        @ 04,02 GET BR_VENC
        @ 04,14 GET BR_DATADOC 
        @ 04,26 GET BR_NUMDOC PICT "9999999999"
        @ 04,38 GET BR_DATAIMPR

        @ 05,01 TO 05,78

        @ 06,02 SAY "Num emp:" GET BR_NUMEMP PICT"9999" VALID(BR_TESTE(BR_NUMEMP))
        @ 06,16 SAY "Cnpj...:" GET BR_CNPJ PICT "99.999.999/0009-99" 
        @ 07,02 SAY "Nome...:" GET BR_NOME
        @ 08,02 SAY "Ender..:" GET BR_ENDER 
        @ 09,02 SAY "CIDADE.:" GET BR_CIDADE
        @ 09,31 say "/"
        @ 09,32                GET BR_UF
        @ 09,35 SAY "BAIRRO" GET BR_BAIRRO

        @ 10,01 TO 10,78
        @ 11,01 SAY "  Valor"        GET BR_VALOR PICT"@e 9,999.99"
        @ 11,18 SAY " -desconto"     GET BR_DESC PICT"@e 9,999.99"
        @ 12,18 SAY " -abatim. "  GET BR_ABAT PICT"@e 9,999.99"
        @ 11,37 SAY " +mora "        GET BR_MORA PICT"@e 9,999.99"
        @ 12,37 SAY " +multa"        GET BR_MULTA PICT"@e 9,999.99"  VALID BRSSOMAN()
        @ 12,55 SAY "  Total"        GET BR_TOTAL PICT"@e 99,999.99"

        @ 13,01 TO 13,78

        @ 14,02 SAY "Instrucoes"
        @ 15,01 GET BR_INSTR2
        @ 16,01 GET BR_INSTR3
        @ 17,01 GET BR_INSTR4
        @ 18,01 GET BR_INSTR5 VALID(BR_CALC(BR_VALOR))
        @ 19,39 GET BR_INSTR6
        @ 20,39 GET BR_INSTR7
RETURN(.T.)



****************************
function consulta_brs()
****************************
*set key -3 to mudaindice()
set key -1 to 
SET COLOR TO &Cor20
USE &shar14
INDEX ON SUBSTR(DTOC(R_VENC),7,4)+SUBSTR(DTOC(R_VENC),4,2)+SUBSTR(DTOC(R_VENC),1,2)+STR(R_NUMEMP) TO &shar15 DESCENDING
SAVE SCRE
    DO WHILE .NOT. (LASTKEY()=27 .or. LASTKEY()=13)
       @ 04,03 TO 20,62
 *      @ 03,04 SAY "<F4> muda o indice"
       TROCA=0
       DBEDIT(05,04,19,61,BR_DB1,"F_DBE",BR_DB2,BR_DB3)
       registro=recno()
 *      PACK
 *      IF LASTKEY()=-3
 *         LOOP
 *      ENDIF
    ENDDO

REST SCRE

      
IF LASTKEY()=13
   go registro
   LEBRS()
   GETS_BRS()
   CLEAR GETS
   KEYB CHR(23)+CHR(13)+CHR(255)
ENDIF
USE 
*set key -3 to
SET COLOR TO &Cor23
set key -1 to consulta_brs()
RETURN(.T.)
****************************
FUNCTION MUDAINDICE()  && ESTA DESATIVADA DA FUNCAO CONSULTA <F2>
****************************
SET KEY -3 TO 
SAVE SCREE
@ 08,25 CLEAR TO 13,50
@ 08,25 TO 13,50
@ 09,27 SAY "ORDEM DE:"
@ 09,36 PROMPT "EMPRESA"
@ 10,36 PROMPT "VENCIMENTO"
@ 11,36 PROMPT "OBSERVACAO 1"
@ 12,36 PROMPT "OBSERVACAO 2"
*MENU TO MUDIN
IF MUDIN=4
   MUDIN=1
  ELSE
   MUDIN++
ENDIF
   
DO CASE
   CASE MUDIN=1
        INDEX ON R_NUMEMP TO &shar15
   CASE MUDIN=2
        INDEX ON R_VENC TO &shar15
   CASE MUDIN=3
        INDEX ON R_OBS1 TO &shar15
   CASE MUDIN=4
        INDEX ON R_OBS2 TO &shar15
ENDCASE
REST SCREE
set key -3 to mudaindice()
RETURN(.T.)

****************************
FUNCTION BR_CALC(BR_VALOR)
****************************
SET DECIMALS TO 4
BR_PERC=(BR_VALOR/1000)
SET DECIMALS TO 2
BR_INSTR7="APOS VENC, MORA R$ "+ALLTRIM(STR(BR_PERC))+" POR DIA         "
RETURN(.T.)

****************************
FUNCTION BR_TESTE(BR_NUMEMP)
****************************
use &shar2 index &shar3
FIND &BR_NUMEMP
IF FOUND()
   LECAD()
   USE
   BR_CNPJ=alltrim(VC_CGCMF)
   BR_NOME=alltrim(VC_NOME)
   BR_ENDER=alltrim(VC_ENDER)
   BR_BAIRRO=alltrim(VC_BAIRRO)
   BR_UF=alltrim(VC_UF)
   BR_CIDADE=alltrim(VC_CIDADE)
   IF !LASTKEY()=5
      KEYB CHR(13)+CHR(13)+CHR(13)+CHR(13)+CHR(13)+CHR(13)
   ENDIF
ENDIF
RETURN(.T.)
   
*******************
FUNCTION BR_IMPRIME()
*******************
SET DEVICE TO PRINT
SET PRINTER TO &IMPLPT
SET PRINTER ON

@ PROW()+02,14  SAY BR_LOCAL
@ PROW()+00,112 SAY BR_VENC

@ PROW()+03,014 SAY BR_DATADOC
@ PROW()+00,040 SAY BR_NUMDOC PICT "9999999999"
@ PROW()+00,084 SAY BR_DATAIMPR

@ PROW()+01,114 SAY BR_VALOR PICT "@E 9,999.99"
@ PROW()+02,014 SAY BR_INSTR2
IF !EMPTY(BR_DESC) 
   @ PROW()+00,114 SAY BR_DESC PICT "@E 9,999.99"
ENDIF
@ PROW()+01,014 SAY BR_INSTR3
IF !EMPTY(BR_ABAT) 
@ PROW()+00,114 SAY BR_ABAT PICT "@E 9,999.99"
ENDIF
@ PROW()+01,014 SAY BR_INSTR4
@ PROW()+01,014 SAY BR_INSTR5

IF !EMPTY(BR_MORA) 
@ PROW()+00,114 SAY BR_MORA PICT "@E 9,999.99"
ENDIF

IF !EMPTY(BR_MULTA) 
@ PROW()+01,114 SAY BR_MULTA PICT "@E 9,999.99"
    ELSE
@ PROW()+01,114 SAY "   "
ENDIF

@ PROW()+01,052 SAY BR_INSTR6 

@ PROW()+01,052 SAY BR_INSTR7
IF !EMPTY(BR_TOTAL) 
@ PROW()+00,114 SAY BR_TOTAL PICT "@E 99,999.99"
ENDIF

IF !EMPTY(BR_CNPJ)
    @ PROW()+01,14 SAY ALLTRIM(BR_NOME)+" -  CNPJ "+BR_CNPJ
   ELSE
    @ PROW()+01,14 SAY ALLTRIM(BR_NOME)
ENDIF

@ PROW()+01,14 SAY ALLTRIM(BR_ENDER)+" - "+ALLTRIM(BR_BAIRRO)+" - "+ALLTRIM(BR_CIDADE)+"/"+ALLTRIM(BR_UF)
@ PROW()+08,14 SAY " "

SET PRINTER TO
SET PRINTER OFF
SET DEVICE TO SCREEN
RETURN(.T.)

***********************
FUNCTION BR_GRAVADOC()
***********************
USE &shar14
IF RLOCK()
APPEND BLANK
REPLACE R_LOCAL WITH BR_LOCAL
REPLACE R_VENC WITH BR_VENC
REPLACE R_DATAIM WITH BR_DATAIMPR
REPLACE R_DATADO WITH BR_DATADOC
REPLACE R_NUMDOC WITH BR_NUMDOC
REPLACE R_VALOR WITH BR_VALOR 
REPLACE R_DESC WITH BR_DESC
REPLACE R_ABAT WITH BR_ABAT
REPLACE R_MORA WITH BR_MORA
REPLACE R_MULTA WITH BR_MULTA
REPLACE R_TOTAL WITH BR_TOTAL
REPLACE R_NUMEMP WITH BR_NUMEMP
REPLACE R_NOME WITH BR_NOME
REPLACE R_ENDER WITH BR_ENDER
REPLACE R_BAIRRO WITH BR_BAIRRO
REPLACE R_CIDADE WITH BR_CIDADE
REPLACE R_UF WITH BR_UF
REPLACE R_CNPJ WITH BR_CNPJ
REPLACE R_INSTR2 WITH BR_INSTR2
REPLACE R_INSTR3 WITH BR_INSTR3
REPLACE R_INSTR4 WITH BR_INSTR4
REPLACE R_INSTR5 WITH BR_INSTR5
REPLACE R_INSTR6 WITH BR_INSTR6
REPLACE R_INSTR7 WITH BR_INSTR7
COMMIT
ENDIF
USE
RETURN(.T.)


*****************************
FUNCTION BRS_LIMPA()
*****************************
SAVE SCREEN
@ 10,25 CLEAR TO 18,60
@ 10,25 SAY "Procurando registros identicos..."
INKEY(0.1)

ZN=0
ZZN=0
ZZZN=0

USE &shar14
INDEX ON STR(R_NUMEMP)+DTOC(R_VENC)+DTOC(R_DATAIM)+STR(R_VALOR) TO &SHAR16
@ 17,25 SAY STR(LASTREC())+" Registros"

GOTO TOP

DO WHILE .NOT. EOF()

LEBRS()
SKIP +1
LEBRSLIMPA()
ZN++
@ 12,27 SAY "PRIMEIRO SKIP " + STR(ZN)

   IF BR_NUMEMP=BBR_NUMEMP .AND.  BR_VENC=BBR_VENC .AND.  BR_DATAIMPR=BBR_DATAIMPR .AND.  BR_DATADOC=BBR_DATADOC
   IF BR_NUMDOC=BBR_NUMDOC .AND.  BR_VALOR=BBR_VALOR .AND.  BR_DESC=BBR_DESC .AND.  BR_ABAT=BBR_ABAT
   IF BR_MORA=BBR_MORA .AND.  BR_MULTA=BBR_MULTA .AND.  BR_TOTAL=BBR_TOTAL .AND.  BR_LOCAL=BBR_LOCAL
   IF BR_NOME=BBR_NOME .AND.  BR_ENDER=BBR_ENDER .AND.  BR_BAIRRO=BBR_BAIRRO .AND.  BR_CIDADE=BBR_CIDADE
   IF BR_UF=BBR_UF .AND.  BR_CNPJ=BBR_CNPJ .AND.  BR_INSTR2=BBR_INSTR2 .AND.  BR_INSTR3=BBR_INSTR3
   IF BR_INSTR4=BBR_INSTR4 .AND.  BR_INSTR5=BBR_INSTR5 .AND.  BR_INSTR6=BBR_INSTR6 .AND.  BR_INSTR7=BBR_INSTR7
   ZZN++
   @ 14,27 SAY "SKIP VOLTA" + STR(ZZN)
      SKIP -1
      DELETE
      PACK
      GOTO TOP
   ENDIF              
   ENDIF
   ENDIF
   ENDIF
   ENDIF
   ENDIF
   SKIP +1
ZZZN++
@ 15,27 SAY "SEGUNDO SKIP " + STR(ZZZN)


ENDDO
RESTORE SCREEN
RETURN(.T.)

******************
FUNCTION LEBRSLIMPA()
******************
BBR_LOCAL = R_LOCAL
BBR_VENC  = R_VENC
BBR_DATAIMPR= R_DATAIM
BBR_DATADOC= R_DATADO
BBR_NUMDOC= R_NUMDOC
BBR_VALOR = R_VALOR 
BBR_DESC  = R_DESC
BBR_ABAT  = R_ABAT
BBR_MORA  = R_MORA
BBR_MULTA = R_MULTA
BBR_TOTAL = R_TOTAL
BBR_NUMEMP= R_NUMEMP
BBR_NOME  = R_NOME
BBR_ENDER = R_ENDER
BBR_BAIRRO= R_BAIRRO
BBR_CIDADE= R_CIDADE
BBR_UF    = R_UF
BBR_CNPJ  = R_CNPJ
BBR_INSTR2= R_INSTR2
BBR_INSTR3= R_INSTR3
BBR_INSTR4= R_INSTR4
BBR_INSTR5= R_INSTR5
BBR_INSTR6= R_INSTR6
BBR_INSTR7= R_INSTR7
RETURN(.T.)

******************
FUNCTION LEBRS()
******************
BR_LOCAL = R_LOCAL
BR_VENC  = R_VENC
BR_DATAIMPR= R_DATAIM
BR_DATADOC= R_DATADO
BR_NUMDOC= R_NUMDOC
BR_VALOR = R_VALOR 
BR_DESC  = R_DESC
BR_ABAT  = R_ABAT
BR_MORA  = R_MORA
BR_MULTA = R_MULTA
BR_TOTAL = R_TOTAL
BR_NUMEMP= R_NUMEMP
BR_NOME  = R_NOME
BR_ENDER = R_ENDER
BR_BAIRRO= R_BAIRRO
BR_CIDADE= R_CIDADE
BR_UF    = R_UF
BR_CNPJ  = R_CNPJ
BR_INSTR2= R_INSTR2
BR_INSTR3= R_INSTR3
BR_INSTR4= R_INSTR4
BR_INSTR5= R_INSTR5
BR_INSTR6= R_INSTR6
BR_INSTR7= R_INSTR7
RETURN(.T.)
********************

FUNCTION BRSSOMAN()

IF !(BR_DESC+BR_ABAT+BR_MORA+BR_MULTA)=0
   BR_TOTAL=BR_VALOR-BR_DESC-BR_ABAT+BR_MORA+BR_MULTA
ENDIF

RETURN(.T.)
